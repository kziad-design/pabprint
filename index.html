<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Sistem Bayaran Print Perpustakaan UiTM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #4e2a7b 0%, #6b4e9a 100%);
        color: #fff;
        font-size: 12px;
        min-height: 100vh;
    }
    header {
        text-align: center;
        padding: 25px 15px;
        background: #a0a0a0;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    header img {
        height: 80px;
        display: block;
        margin: 0 auto 15px auto;
    }
    header h2 {
        margin: 8px 0;
        font-size: 20px;
        font-weight: bold;
    }
    header div {
        font-size: 13px;
        opacity: 0.9;
    }
    .wrap {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
        display: flex;
        gap: 25px;
    }
    #leftPanel {
        width: 350px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    #rightPanel {
        flex: 1;
        min-width: 600px;
        display: flex;
        flex-direction: column;
    }
    .card {
        background: white;
        color: #333;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        font-size: 12px;
    }
    label {
        font-weight: 600;
        display: block;
        margin-top: 8px;
        color: #555;
        font-size: 11px;
    }
    input, select, button {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        margin-bottom: 12px;
        font-size: 13px;
        box-sizing: border-box;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        transition: all 0.3s;
    }
    input:focus, select:focus {
        outline: none;
        border-color: #4e2a7b;
        box-shadow: 0 0 0 3px rgba(78,42,123,0.1);
    }
    button {
        cursor: pointer;
        background: linear-gradient(135deg, #4e2a7b, #6b4e9a);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s;
        height: 45px;
    }
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(78,42,123,0.4);
    }
    .btn-secondary { background: #6c757d; }
    .btn-secondary:hover { box-shadow: 0 8px 25px rgba(108,117,125,0.4); }
    .btn-warning { background: linear-gradient(135deg, #ffc107, #ffed4e); color: #333; }
    .btn-info { background: linear-gradient(135deg, #17a2b8, #20c997); }
    .btn-danger { background: linear-gradient(135deg, #dc3545, #e74c3c); }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    th, td {
        padding: 12px 8px;
        border: 1px solid #ddd;
        text-align: center;
        vertical-align: middle;
    }
    th {
        background: linear-gradient(135deg, #4e2a7b, #6b4e9a);
        color: white;
        font-weight: 600;
        font-size: 12px;
    }
    .action-btn {
        padding: 6px 12px;
        margin: 2px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
    }
    .edit-btn { background: #ffc107; color: #333; }
    .delete-btn { background: #dc3545; color: white; }
    /* SCROLL TABLE BARU */
    #reportTableContainer {
        max-height: 350px;
        overflow-y: auto;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        background: white;
    }
    #reportTableContainer::-webkit-scrollbar {
        width: 8px;
    }
    #reportTableContainer::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    #reportTableContainer::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #4e2a7b, #6b4e9a);
        border-radius: 10px;
    }
    #reportTable thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    #paymentPopup {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
    }
    #popupBox {
        background: white;
        padding: 30px;
        width: 90%;
        max-width: 400px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        transform: scale(0.7);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        color: #333;
    }
    .popup-show {
        transform: scale(1) !important;
        opacity: 1 !important;
    }
    #editModal {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(3px);
    }
    #editBox {
        background: white;
        padding: 25px;
        width: 90%;
        max-width: 450px;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        transform: translateY(50px);
        transition: all 0.3s;
    }
    #adminSection { display: none; }
    .report-header {
        text-align: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid #4e2a7b;
    }
    .staf-panel {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        border: 2px solid #e9ecef;
    }
    .staf-left { display: flex; gap: 20px; align-items: center; }
    .staf-right { text-align: right; }
    .total-row {
        background: linear-gradient(135deg, #4e2a7b, #6b4e9a) !important;
        color: white !important;
        font-weight: bold !important;
        font-size: 13px;
    }
    @media print {
        body { background: white !important; color: black !important; }
        .wrap { display: block !important; max-width: none; }
        #leftPanel, button, .action-btn, #reportTableContainer { display: none !important; }
        #adminSection { display: block !important; }
        input { border: none !important; background: transparent !important; font-weight: bold; }
    }
    @media (max-width: 1000px) {
        .wrap { flex-direction: column; }
        #leftPanel { width: 100%; }
    }
</style>
</head>
<body>
<!-- =================== POPUP BAYARAN =================== -->
<div id="paymentPopup">
    <div id="popupBox">
        <h3 style="margin:0 0 15px 0; color:#28a745; font-size: 22px;">‚úÖ Berjaya Di Rekodkan!</h3>
        <p id="popupName" style="font-size:16px; font-weight:600; margin:5px 0;"></p>
        <p id="popupId" style="font-size:14px; color:#666; margin:5px 0;"></p>
        <p id="popupTotal" style="font-size:32px; font-weight:bold; color:#28a745; margin:15px 0;"></p>
        <p id="popupDate" style="font-size:13px; color:#888;"></p>
        <button onclick="closePaymentPopup()" 
                style="background:linear-gradient(135deg,#28a745,#20c997); color:white; padding:15px 30px; margin-top:20px; width:100%; border:none; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer; box-shadow:0 8px 25px rgba(40,167,69,0.4);">
            OK
        </button>
    </div>
</div>

<!-- =================== MODAL EDIT =================== -->
<div id="editModal">
    <div id="editBox">
        <h3 style="margin-top:0; color:#4e2a7b;">‚úèÔ∏è Edit Bayaran</h3>
        <label>Nama Pelanggan:</label><input id="editName">
        <label>No Pelajar/ID:</label><input id="editStudentId">
        <label>Bilangan Salinan:</label><input id="editCopies" type="number" min="1">
        <label>Jenis Kertas:</label>
        <select id="editPaper">
            <option value="0.20|üìÑ A4 RM0.20">üìÑ A4 RM0.20</option>
            <option value="0.30|üìÑ A4 depan belakang RM0.30">üìÑ A4 depan belakang RM0.30</option>
            <option value="1.00|üåà A4 Warna RM1.00">üåà A4 Warna RM1.00</option>
            <option value="2.00|üåà A4 Warna depan belakang RM2.00">üåà A4 Warna depan belakang RM2.00</option>
            <option value="0.10|üìÑ A4 Kertas Sendiri RM0.10">üìÑ A4 Kertas Sendiri RM0.10</option>
            <option value="0.20|üìÑ A4 Kertas Sendiri depan belakang RM0.20">üìÑ A4 Kertas Sendiri depan belakang RM0.20</option>
            <option value="0.40|üìê A3 RM0.40">üìê A3 RM0.40</option>
            <option value="0.60|üìê A3 depan belakang RM0.60">üìê A3 depan belakang RM0.60</option>
            <option value="1.00|üåà A3 Warna RM1.00">üåà A3 Warna RM1.00</option>
            <option value="2.00|üåà A3 Warna depan belakang RM2.00">üåà A3 Warna depan belakang RM2.00</option>
            <option value="0.10|üìê A3 Kertas Sendiri RM0.10">üìê A3 Kertas Sendiri RM0.10</option>
            <option value="0.20|üìê A3 Kertas Sendiri depan belakang RM0.20">üìê A3 Kertas Sendiri depan belakang RM0.20</option>
        </select>
        <label>Jenis Warna:</label>
        <select id="editColor">
            <option value="Hitam Putih">Hitam Putih</option>
            <option value="Warna">Warna</option>
        </select>
        <div style="display:flex; gap:12px; margin-top:20px;">
            <button onclick="saveEdit()" style="flex:1; background:linear-gradient(135deg,#28a745,#20c997);">üíæ Simpan</button>
            <button onclick="closeEditModal()" class="btn-secondary" style="flex:1;">‚ùå Tutup</button>
        </div>
    </div>
</div>

<!-- =================== HEADER UTAMA =================== -->
<header>
    <img src="https://www.teamcetak.com/wp-content/uploads/2019/03/uitm-universiti-teknologi-mara-logo-png-transparent.png" alt="Logo UiTM">
    <h2>üñ®Ô∏è Sistem Rekod Bayaran Print Perpustakaan</h2>
    <div>Perpustakaan Al-Bukhari | UiTM Cawangan Pahang</div>
</header>

<!-- =================== KANDUNGAN UTAMA =================== -->
<div class="wrap">
    <!-- ========== PANEL KIRI: BORANG BAYARAN ========== -->
    <div id="leftPanel">
        <div class="card" id="paymentContainer">
            <h3 style="margin-top:0; color:#4e2a7b; display:flex; align-items:center; gap:10px;">
                Rekod Bayaran Print
            </h3>
            <label>Nama Pelanggan:</label>
            <input id="name" placeholder="Masukkan nama lengkap pelanggan">
            <label>No Pelajar / Staf / Luar:</label>
            <input id="studentId" placeholder="Contoh: 2020123456 / ST001 / LUAR001">
            <label>Bilangan Salinan:</label>
            <input id="copies" type="number" value="1" min="1">
            <label>Jenis Kertas:</label>
            <select id="paper">
                <option value="0.20">üìÑ A4 RM0.20</option>
                <option value="0.30">üìÑ A4 depan belakang RM0.30</option>
                <option value="1.00">üåà A4 Warna RM1.00</option>
                <option value="2.00">üåà A4 Warna depan belakang RM2.00</option>
                <option value="0.10">üìÑ A4 Kertas Sendiri RM0.10</option>
                <option value="0.20">üìÑ A4 Kertas Sendiri depan belakang RM0.20</option>
                <option value="0.40">üìê A3 RM0.40</option>
                <option value="0.60">üìê A3 depan belakang RM0.60</option>
                <option value="1.00">üåà A3 Warna RM1.00</option>
                <option value="2.00">üåà A3 Warna depan belakang RM2.00</option>
                <option value="0.10">üìê A3 Kertas Sendiri RM0.10</option>
                <option value="0.20">üìê A3 Kertas Sendiri depan belakang RM0.20</option>
            </select>
            <label>Jenis Warna:</label>
            <select id="color">
                <option value="Hitam Putih">‚ö´ Hitam Putih</option>
                <option value="Warna">üåà Warna</option>
            </select>
            <button onclick="addPayment()">Hantar</button>
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px; font-size:11px; text-align:center; color:#333;">
                <strong>üîê Akses Staf/Report:</strong><br>
                Tekan <kbd style="background:#4e2a7b; color:white; padding:2px 6px; border-radius:4px;">Alt + S</kbd>
            </div>
        </div>

        <!-- ========== LOGIN STAF ( tersembunyi ) ========== -->
        <div class="card" id="loginContainer" style="display:none;">
            <h3 style="margin-top:0; color:#dc3545;">üîê Login Staf Perpustakaan</h3>
            <label>Password Staf:</label>
           <input id="staffPassword" type="password" placeholder="Masukkan kata laluan staf" onkeydown="if(event.key==='Enter') staffLogin()">
            <button onclick="staffLogin()" style="background:linear-gradient(135deg,#dc3545,#e74c3c);">üîë Masuk</button>
            <button onclick="cancelStaffLogin()" class="btn-secondary">‚ùå Batal</button>
            <div style="font-size:10px; color:#666; text-align:center; margin-top:10px;">
                Akses khusus pegawai perpustakaan sahaja
            </div>
        </div>
    </div>
    <!-- ========== PANEL KANAN: REPORT ADMIN ========== -->
    <div id="rightPanel">
        <div class="card" id="adminSection" style="display:none;">
            <!-- HEADER REPORT -->
            <div class="report-header">
                <h3 style="margin:0; color:#4e2a7b; font-size:24px;">LAPORAN BAYARAN PRINT</h3>
                <p style="margin:5px 0 0 0; font-size:13px; color:#666;">Perpustakaan Al-Bukhari, UiTM Cawangan Pahang</p>
            </div>

            <!-- INFO STAF & TARIKH -->
            <div class="staf-panel">
                <div class="staf-left">
                    <img src="https://www.teamcetak.com/wp-content/uploads/2019/03/uitm-universiti-teknologi-mara-logo-png-transparent.png" style="height:50px;">
                    <div>
                        <label style="margin-top:0;">Staf Bertugas:</label>
                        <input id="inputStafBertugas" type="text" placeholder="Nama staf bertugas">
                        <label>Kerja Normal:</label>
                        <input id="inputStafNormal" type="text" placeholder="Nama staf normal">
                    </div>
                </div>
                <div class="staf-right">
                    <label>Kerja Shift:</label>
                    <input id="inputStafShift" type="text" placeholder="Nama staf shift">
                    <label>Kerja Lebih Masa:</label>
                    <input id="inputStafLebihMasa" type="text" placeholder="Nama lebih masa">
                    <div style="margin-top:15px; padding:12px; background:#4e2a7b; color:white; border-radius:8px; text-align:center;">
                        <strong>Tarikh Janaan Report:</strong><br>
                        <span id="tarikhJanaan" style="font-size:16px; font-weight:bold;"></span>
                    </div>
                </div>
            </div>

    <!-- FILTER & BUTANG (versi kolum, butang di bawah) -->
<div style="margin-bottom:20px;">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:10px;">
        <div>
            <label>Tarikh Mula:</label>
            <input id="startDate" type="date">
        </div>
        <div>
            <label>Tarikh Tamat:</label>
            <input id="endDate" type="date">
        </div>
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-start;">
        <button onclick="generateReport()" style="height:40px; min-width:150px;">üîç Generate Report</button>
        <button onclick="clearDateFilter()" class="btn-secondary" style="height:40px; min-width:150px;">üóëÔ∏è Kosong Filter</button>
    </div>
</div>



            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:25px;">
                <button onclick="exportCSV()" class="btn-info">üì• Export CSV</button>
                <button onclick="downloadReport()" class="btn-warning">üìÑ Download Laporan</button>
                <button onclick="softReset()" class="btn-secondary">üóëÔ∏è Kosong Paparan</button>
                <button onclick="staffLogout()" style="background:linear-gradient(135deg,#6c757d,#495057);">üö™ Logout</button>
            </div>

            <!-- JADUAL REPORT DENGAN TARIKH BAYARAN + SCROLL -->
            <div id="reportTableContainer">
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th style="width:5%;">Bil.</th>
                            <th style="width:12%;">No Pelajar</th>
                            <th style="width:20%;">Nama</th>
                            <th style="width:10%;">RM Hitam<br>Putih</th>
                            <th style="width:10%;">RM Warna</th>
                            <th style="width:16%;">Tarikh Bayaran</th> <!-- TAMBAH KOLUM TARIKH -->
                            <th style="width:12%;">No Resit<br>(Manual)</th>
                            <th style="width:15%;">Tindakan</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody">
                        <tr><td colspan="8" style="color:#999; font-style:italic; padding:40px; font-size:14px;">Tiada data. Klik Generate Report untuk paparan lengkap.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

<script>
    // Firebase config
 const firebaseConfig = {
    apiKey: "AIzaSyCWpeosUEpLAEzM39BRJmwmm8aNDNUfloY",
    authDomain: "pab-printing-system.firebaseapp.com",
    projectId: "pab-printing-system",
    storageBucket: "pab-printing-system.firebasestorage.app",
    messagingSenderId: "890265108988",
    appId: "1:890265108988:web:052934b1f65570e7c17279",
    databaseURL: "https://pab-printing-system-default-rtdb.asia-southeast1.firebasedatabase.app"
};


    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const paymentsRef = db.ref("payments");

    let payments = [];
    let editIndex = null;
    const STAFF_PASSWORD = "1234";

    // Auto login anonymous
    auth.signInAnonymously().catch(console.error);
    auth.onAuthStateChanged((user) => {
        if (user) {
            console.log('‚úÖ Firebase login OK');
            loadPayments();
        }
    });

    // Load data real-time
    function loadPayments() {
        paymentsRef.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            payments = Object.entries(data).map(([key, value]) => ({
                ...value,
                _id: key
            }));
            console.log('üìä Payments loaded:', payments.length, 'rekod');
        });
    }

    // Tambah payment
    function addPayment() {
        const name = document.getElementById("name").value.trim();
        const id = document.getElementById("studentId").value.trim();
        const copies = parseInt(document.getElementById("copies").value);
        const paperSelect = document.getElementById("paper");
        const paperPrice = parseFloat(paperSelect.value);
        const color = document.getElementById("color").value;

        if(!name || !id || copies < 1) {
            alert("‚ùå Sila lengkapkan semua maklumat!");
            return;
        }

        const total = (paperPrice * copies).toFixed(2);
        const now = new Date();
        const receipt = "R" + String(payments.length + 1).padStart(3, "0");
        const paymentDate = now.toLocaleDateString('ms-MY', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        const payment = {
            receipt, name, id, copies,
            paper: paperSelect.options[paperSelect.selectedIndex].text,
            color, total, 
            datetime: now.toISOString(),
            paymentDate: paymentDate,
            manualReceipt: ""
        };

        // Simpan ke Firebase
        paymentsRef.push(payment).then(() => {
            console.log('‚úÖ Data masuk Firebase!');
            document.getElementById("name").value = "";
            document.getElementById("studentId").value = "";
            document.getElementById("copies").value = 1;
        }).catch((error) => {
            console.error('‚ùå Error:', error);
            alert('Error: ' + error.message);
        });

        // Popup
        document.getElementById("popupName").textContent = name;
        document.getElementById("popupId").textContent = `No Pelajar: ${id}`;
        document.getElementById("popupTotal").textContent = `RM ${total}`;
        document.getElementById("popupDate").textContent = `Tarikh: ${paymentDate}`;

        const popup = document.getElementById("paymentPopup");
        const box = document.getElementById("popupBox");
        popup.style.display = "flex";
        box.classList.remove("popup-show");
        setTimeout(() => box.classList.add("popup-show"), 100);
        setTimeout(() => {
            box.classList.remove("popup-show");
            setTimeout(() => popup.style.display = "none", 400);
        }, 3000);
    }

    function closePaymentPopup(){
        const popup = document.getElementById("paymentPopup");
        const box = document.getElementById("popupBox");
        box.classList.remove("popup-show");
        setTimeout(() => popup.style.display = "none", 400);
    }

    // Shortcut Alt+S
    document.addEventListener("keydown", e => {
        if(e.altKey && e.key.toLowerCase() === "s") {
            e.preventDefault();
            const login = document.getElementById("loginContainer");
            if(login.style.display === "none") {
                login.style.display = "block";
                document.getElementById("staffPassword").focus();
            }
        }
    });

        // ====== STAFF LOGIN FUNCTIONS (PERTAMA DULU) ======
    function staffLogin() {
        if(document.getElementById("staffPassword").value === STAFF_PASSWORD) {
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("adminSection").style.display = "block";
            document.getElementById("tarikhJanaan").textContent = new Date().toLocaleDateString('ms-MY');
            console.log('‚úÖ Staff login OK');
        } else {
            alert("‚ùå Password salah!");
            document.getElementById("staffPassword").value = "";
        }
    }

    function cancelStaffLogin() {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("staffPassword").value = "";
    }

    function staffLogout() {
        document.getElementById("adminSection").style.display = "none";
    }

    // ====== GENERATE REPORT DARI FIREBASE ======
    function generateReport() {
        const tbody = document.getElementById("reportBody");
        tbody.innerHTML = "<tr><td colspan='8' style='padding:50px;'><div>‚è≥ Memuatkan data...</div></td></tr>";

        const allData = payments || [];
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;

        let filtered = allData.filter(p => {
            if (!startDate && !endDate) return true;
            const paymentDate = new Date(p.datetime);
            paymentDate.setHours(0, 0, 0, 0);
            const start = startDate ? new Date(startDate + 'T00:00:00') : null;
            const end = endDate ? new Date(endDate + 'T23:59:59.999') : null;
            return (!start || paymentDate >= start) && (!end || paymentDate <= end);
        });

        document.getElementById("tarikhJanaan").textContent = new Date().toLocaleDateString('ms-MY');

        if(filtered.length === 0) {
            tbody.innerHTML = "<tr><td colspan='8' style='color:#999; font-style:italic; padding:40px;'>Tiada rekod dalam julat tarikh ini</td></tr>";
            return;
        }

        let totalHP = 0, totalWarna = 0, grandTotal = 0;
        tbody.innerHTML = "";

        filtered.forEach((payment, index) => {
            const hp = payment.color === "Hitam Putih" ? parseFloat(payment.total) : 0;
            const warna = payment.color !== "Hitam Putih" ? parseFloat(payment.total) : 0;
            totalHP += hp;
            totalWarna += warna;
            grandTotal += parseFloat(payment.total);

            const dataIndex = allData.findIndex(p => p._id === payment._id);

            tbody.innerHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td style="font-size:11px;">${payment.id}</td>
                    <td style="font-size:11px;">${payment.name}</td>
                    <td>RM ${hp.toFixed(2)}</td>
                    <td>RM ${warna.toFixed(2)}</td>
                    <td style="font-size:11px; font-weight:500;">${payment.paymentDate}</td>
                    <td><input type="text" value="${payment.manualReceipt || ''}" onblur="updateManualReceipt(${dataIndex}, this.value)" style="width:95%; border:1px solid #ddd; padding:4px; border-radius:4px; font-size:11px;"></td>
                    <td><button class="action-btn edit-btn" onclick="startEdit(${dataIndex})">Edit</button><button class="action-btn delete-btn" onclick="deletePayment(${dataIndex})">Padam</button></td>
                </tr>`;
        });

        tbody.innerHTML += `
            <tr class="total-row">
                <td colspan="3" style="text-align:right; padding-right:15px;">Jumlah Keseluruhan</td>
                <td>RM ${totalHP.toFixed(2)}</td>
                <td>RM ${totalWarna.toFixed(2)}</td>
                <td>RM ${grandTotal.toFixed(2)}</td>
                <td colspan="2"></td>
            </tr>`;
    }

    // ====== EXPOSE ALL FUNCTIONS TO GLOBAL (AKHIR SAJA) ======
    window.addPayment = addPayment;
    window.closePaymentPopup = closePaymentPopup;
    window.staffLogin = staffLogin;
    window.cancelStaffLogin = cancelStaffLogin;
    window.staffLogout = staffLogout;
    window.generateReport = generateReport;
    window.clearDateFilter = clearDateFilter;
    window.updateManualReceipt = updateManualReceipt;
    window.startEdit = startEdit;
    window.closeEditModal = closeEditModal;
    window.saveEdit = saveEdit;
    window.deletePayment = deletePayment;
    window.softReset = softReset;
    window.exportCSV = exportCSV;
    window.downloadReport = downloadReport;

</script>

</script>
</body>
</html>
